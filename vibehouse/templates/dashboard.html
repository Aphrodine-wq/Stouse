{% extends "base.html" %}

{% block title %}Dashboard — VibeHouse{% endblock %}
{% block nav_dash_class %}active{% endblock %}

{% block body %}
<div class="dash-page">

  <!-- Header -->
  <div class="dash-header fade-in-up">
    <p class="dash-greeting" id="dashGreeting">Good {{ time_of_day }}</p>
    <h1>Your Projects</h1>
  </div>

  <div class="dash-content">

    <!-- Overview Stats -->
    <div class="overview-stats" data-stagger>
      <div class="overview-stat">
        <div class="stat-icon">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        </div>
        <div class="stat-number" id="statProjects">0</div>
        <div class="stat-title">Active Projects</div>
      </div>
      <div class="overview-stat">
        <div class="stat-icon">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#34C759" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        </div>
        <div class="stat-number" id="statBudget">$0</div>
        <div class="stat-title">Total Budget</div>
      </div>
      <div class="overview-stat">
        <div class="stat-icon">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#FF9500" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        </div>
        <div class="stat-number" id="statSpent">$0</div>
        <div class="stat-title">Spent</div>
      </div>
      <div class="overview-stat">
        <div class="stat-icon">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#AF52DE" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        </div>
        <div class="stat-number" id="statNotifications">0</div>
        <div class="stat-title">Notifications</div>
      </div>
    </div>

    <!-- New project CTA -->
    <div style="margin-bottom: var(--space-lg);">
      <a href="/projects/new" class="btn btn-filled btn-filled-lg">+ New Project</a>
    </div>

    <!-- Section Label -->
    <div class="ios-section-header">Your projects</div>

    <!-- Project Cards (dynamic) -->
    <div class="project-grid" data-stagger id="projectGrid">
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Loading projects...</p>
      </div>
    </div>

    <!-- Section Label -->
    <div class="ios-section-header" id="activity">Recent notifications</div>

    <!-- Notifications Feed -->
    <div class="activity-section">
      <div class="activity-section-header">
        <h2>Notifications</h2>
        <button class="btn btn-plain text-footnote" onclick="markAllRead()">Mark All Read</button>
      </div>
      <div id="notificationsFeed">
        <div class="activity-feed-item">
          <div class="activity-feed-body">
            <div class="activity-feed-desc text-secondary">No notifications yet</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const token = localStorage.getItem('access_token');
if (!token) {
  window.location.href = '/login';
} else {
  // Set user name in greeting
  var user = JSON.parse(localStorage.getItem('user') || '{}');
  if (user.full_name) {
    document.getElementById('dashGreeting').textContent =
      'Good {{ time_of_day }}, ' + user.full_name.split(' ')[0];
  }
}

const headers = {'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json'};

const STATUS_COLORS = {
  draft: 'var(--text-secondary)',
  designing: 'var(--sys-blue)',
  planning: 'var(--sys-orange)',
  in_progress: 'var(--sys-green)',
  on_hold: 'var(--sys-orange)',
  completed: 'var(--sys-blue)',
  cancelled: 'var(--sys-red)',
};

async function loadDashboard() {
  try {
    const resp = await fetch('/api/v1/projects', {headers: headers});
    if (resp.status === 403 || resp.status === 401) {
      localStorage.removeItem('access_token');
      window.location.href = '/login';
      return;
    }
    if (!resp.ok) return;
    const data = await resp.json();
    const projects = data.projects || [];

    // Update stats
    document.getElementById('statProjects').textContent = projects.length;
    var totalBudget = projects.reduce(function(s, p) { return s + (parseFloat(p.budget) || 0); }, 0);
    var totalSpent = projects.reduce(function(s, p) { return s + (parseFloat(p.budget_spent) || 0); }, 0);
    document.getElementById('statBudget').textContent = '$' + Math.round(totalBudget).toLocaleString();
    document.getElementById('statSpent').textContent = '$' + Math.round(totalSpent).toLocaleString();

    // Render project cards
    var grid = document.getElementById('projectGrid');
    if (!projects.length) {
      grid.innerHTML = '<div class="empty-state"><h3>No projects yet</h3><p class="text-secondary">Create your first project to get started.</p><a href="/projects/new" class="btn btn-primary mt-md">Create Project</a></div>';
      return;
    }

    grid.innerHTML = projects.map(function(p) {
      var status = p.status || 'draft';
      var statusLabel = status.replace('_', ' ');
      var budget = p.budget ? '$' + Math.round(parseFloat(p.budget)).toLocaleString() : '—';
      var color = STATUS_COLORS[status] || 'var(--text-secondary)';
      return '<a href="/projects/' + p.id + '" class="project-card" style="text-decoration:none;color:inherit;">' +
        '<div class="project-card-header">' +
          '<div><h3>' + p.title + '</h3>' +
          (p.address ? '<p class="text-footnote text-secondary mt-sm">' + p.address + '</p>' : '') +
          '</div>' +
          '<span class="project-status status-' + status + '">' + statusLabel + '</span>' +
        '</div>' +
        '<div class="project-card-meta">' +
          '<div class="meta-item">Budget <span class="meta-value">' + budget + '</span></div>' +
          '<div class="meta-item">Status <span class="meta-value">' + statusLabel + '</span></div>' +
        '</div>' +
      '</a>';
    }).join('');
  } catch (e) { console.error(e); }
}

async function loadNotifications() {
  try {
    var resp = await fetch('/api/v1/notifications?limit=10', {headers: headers});
    if (!resp.ok) return;
    var data = await resp.json();
    document.getElementById('statNotifications').textContent = data.unread_count || 0;

    if (data.notifications && data.notifications.length) {
      var feed = document.getElementById('notificationsFeed');
      var iconColors = {
        project_update: 'var(--sys-blue)',
        design_ready: 'var(--sys-indigo)',
        bid_received: 'var(--sys-orange)',
        payment_received: 'var(--sys-green)',
        dispute_filed: 'var(--sys-red)',
        task_completed: 'var(--sys-green)',
        report_ready: 'var(--sys-purple)',
        system: 'var(--text-secondary)',
      };
      feed.innerHTML = data.notifications.map(function(n) {
        var color = iconColors[n.type] || 'var(--sys-blue)';
        var bg = color.replace(')', ',0.12)').replace('var(', 'rgba(');
        return '<div class="activity-feed-item"' + (!n.is_read ? ' style="background: var(--bg-tertiary);"' : '') + '>' +
          '<div class="activity-feed-body">' +
            '<div class="activity-feed-title">' + n.title + '</div>' +
            '<div class="activity-feed-desc">' + n.message + '</div>' +
          '</div>' +
          '<div class="activity-feed-time">' + new Date(n.created_at).toLocaleDateString() + '</div>' +
        '</div>';
      }).join('');
    }
  } catch (e) {}
}

async function markAllRead() {
  try {
    await fetch('/api/v1/notifications/read-all', {method: 'POST', headers: headers});
    document.getElementById('statNotifications').textContent = '0';
  } catch (e) {}
}

loadDashboard();
loadNotifications();
</script>
{% endblock %}
