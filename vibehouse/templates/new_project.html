{% extends "base.html" %}
{% block title %}New Project — VibeHouse{% endblock %}

{% block body %}
<div class="page-container fade-in-up">
  <div class="page-header">
    <a href="/dashboard" class="btn btn-plain">&larr; Back</a>
    <h1>Start a New Project</h1>
    <p class="text-secondary">Describe your dream home and we'll handle the rest</p>
  </div>

  <div class="wizard-container">
    <!-- Step indicator -->
    <div class="wizard-steps">
      <div class="wizard-step active" data-step="1"><span class="step-num">1</span> Basics</div>
      <div class="wizard-step" data-step="2"><span class="step-num">2</span> Your Vibe</div>
      <div class="wizard-step" data-step="3"><span class="step-num">3</span> Budget</div>
    </div>

    <form id="projectForm">
      <!-- Step 1: Basics -->
      <div class="wizard-panel active" id="step1">
        <div class="ios-card">
          <h2>Project Details</h2>
          <div class="form-group">
            <label for="title">Project Name</label>
            <input type="text" id="title" placeholder="e.g., Oak Street Ranch" required>
          </div>
          <div class="form-group">
            <label for="address">Property Address</label>
            <input type="text" id="address" placeholder="123 Main St, Austin, TX 78701">
          </div>
          <button type="button" class="btn btn-primary btn-full" onclick="showStep(2)">Continue</button>
        </div>
      </div>

      <!-- Step 2: Vibe -->
      <div class="wizard-panel" id="step2">
        <div class="ios-card">
          <h2>Describe Your Dream Home</h2>
          <p class="text-secondary mb-md">Tell us everything — style, feel, must-haves, deal-breakers. The more detail, the better our AI can design for you.</p>
          <div class="form-group">
            <label for="vibe">Your Vibe</label>
            <textarea id="vibe" rows="8" placeholder="I want a 3-bedroom modern farmhouse with an open kitchen, big porch, natural materials, lots of light..."></textarea>
          </div>
          <div class="vibe-suggestions">
            <span class="suggestion-chip" onclick="addVibe('modern farmhouse')">Modern Farmhouse</span>
            <span class="suggestion-chip" onclick="addVibe('mid-century modern')">Mid-Century Modern</span>
            <span class="suggestion-chip" onclick="addVibe('contemporary minimalist')">Minimalist</span>
            <span class="suggestion-chip" onclick="addVibe('craftsman bungalow')">Craftsman</span>
            <span class="suggestion-chip" onclick="addVibe('Mediterranean villa')">Mediterranean</span>
            <span class="suggestion-chip" onclick="addVibe('coastal cottage')">Coastal</span>
          </div>
          <div class="btn-row">
            <button type="button" class="btn btn-secondary" onclick="showStep(1)">Back</button>
            <button type="button" class="btn btn-primary" onclick="showStep(3)">Continue</button>
          </div>
        </div>
      </div>

      <!-- Step 3: Budget -->
      <div class="wizard-panel" id="step3">
        <div class="ios-card">
          <h2>Budget Range</h2>
          <p class="text-secondary mb-md">This helps us calibrate design options and find the right contractors.</p>
          <div class="form-group">
            <label for="budget">Total Budget ($)</label>
            <input type="number" id="budget" placeholder="250000" min="10000" step="5000">
          </div>
          <div class="budget-presets">
            <button type="button" class="preset-chip" onclick="setBudget(100000)">$100K</button>
            <button type="button" class="preset-chip" onclick="setBudget(250000)">$250K</button>
            <button type="button" class="preset-chip" onclick="setBudget(500000)">$500K</button>
            <button type="button" class="preset-chip" onclick="setBudget(1000000)">$1M+</button>
          </div>
          <div id="projectError" class="form-error" style="display:none;"></div>
          <div class="btn-row">
            <button type="button" class="btn btn-secondary" onclick="showStep(2)">Back</button>
            <button type="submit" class="btn btn-primary" id="createBtn">Create Project</button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showStep(n) {
  document.querySelectorAll('.wizard-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
  document.getElementById('step' + n).classList.add('active');
  document.querySelector('[data-step="' + n + '"]').classList.add('active');
}

function addVibe(text) {
  const ta = document.getElementById('vibe');
  ta.value = ta.value ? ta.value + ', ' + text : text;
  ta.focus();
}

function setBudget(val) {
  document.getElementById('budget').value = val;
}

document.getElementById('projectForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const token = localStorage.getItem('access_token');
  if (!token) { window.location.href = '/login'; return; }

  const btn = document.getElementById('createBtn');
  const errEl = document.getElementById('projectError');
  btn.disabled = true;
  btn.textContent = 'Creating...';
  errEl.style.display = 'none';

  try {
    const resp = await fetch('/api/v1/projects', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
      },
      body: JSON.stringify({
        title: document.getElementById('title').value,
        vibe_description: document.getElementById('vibe').value || null,
        address: document.getElementById('address').value || null,
        budget: document.getElementById('budget').value ? parseFloat(document.getElementById('budget').value) : null,
      }),
    });
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.detail || 'Failed to create project');
    window.location.href = '/projects/' + data.id;
  } catch (err) {
    errEl.textContent = err.message;
    errEl.style.display = 'block';
    btn.disabled = false;
    btn.textContent = 'Create Project';
  }
});
</script>
{% endblock %}
